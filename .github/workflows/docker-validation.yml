name: Docker Configuration Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docker/**'
      - 'composer.json'
      - '.github/workflows/docker-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docker/**'
      - 'composer.json'
      - '.github/workflows/docker-validation.yml'

jobs:
  validate-docker-files:
    name: Validate Docker Configuration Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check required files exist
      run: |
        echo "ğŸ” Checking for required files..."
        
        # Array of required Docker files
        required_docker_files=(
          "docker/Dockerfile"
          "docker/docker-compose.yml"
          "docker/.dockerignore"
        )
        
        # Array of required root files
        required_root_files=(
          "composer.json"
          "index.php"
        )
        
        # Array of optional but recommended files
        optional_files=(
          "README.md"
          "SECURITY.md"
          "LICENSE"
          "phpcs.xml"
          "version.json"
          "composer.lock"
          "docs/"
          "src/"
          "templates/"
        )
        
        missing_files=()
        
        # Check required Docker files
        echo "âœ… Checking required Docker files:"
        for file in "${required_docker_files[@]}"; do
          if [[ -e "$file" ]]; then
            echo "  âœ“ $file exists"
          else
            echo "  âŒ $file is missing"
            missing_files+=("$file")
          fi
        done
        
        # Check required root files
        echo ""
        echo "âœ… Checking required root files:"
        for file in "${required_root_files[@]}"; do
          if [[ -e "$file" ]]; then
            echo "  âœ“ $file exists"
          else
            echo "  âŒ $file is missing"
            missing_files+=("$file")
          fi
        done
        
        # Check optional files
        echo ""
        echo "ğŸ“‹ Checking optional/recommended files:"
        for file in "${optional_files[@]}"; do
          if [[ -e "$file" ]]; then
            echo "  âœ“ $file exists"
          else
            echo "  âš ï¸  $file is missing (recommended)"
          fi
        done
        
        # Exit with error if required files are missing
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo ""
          echo "âŒ Missing required files: ${missing_files[*]}"
          exit 1
        else
          echo ""
          echo "âœ… All required files are present!"
        fi

    - name: Validate Dockerfile syntax
      run: |
        echo "ğŸ” Validating Dockerfile syntax..."
        
        # Check if Dockerfile has basic required instructions
        if ! grep -q "^FROM" docker/Dockerfile; then
          echo "âŒ Dockerfile missing FROM instruction"
          exit 1
        fi
        
        if ! grep -q "^WORKDIR" docker/Dockerfile; then
          echo "âš ï¸  Dockerfile missing WORKDIR instruction (recommended)"
        fi
        
        if ! grep -q "^EXPOSE" docker/Dockerfile; then
          echo "âš ï¸  Dockerfile missing EXPOSE instruction (recommended)"
        fi
        
        if ! grep -q "^CMD\|^ENTRYPOINT" docker/Dockerfile; then
          echo "âŒ Dockerfile missing CMD or ENTRYPOINT instruction"
          exit 1
        fi
        
        # Check for common issues
        if grep -q "COPY \." docker/Dockerfile && [[ ! -f "docker/.dockerignore" ]]; then
          echo "âš ï¸  Dockerfile copies entire directory but no .dockerignore found"
        fi
        
        echo "âœ… Dockerfile syntax validation passed!"

    - name: Validate docker-compose.yml syntax
      run: |
        echo "ğŸ” Validating docker-compose.yml syntax..."
        
        # Change to docker directory for validation
        cd docker
        
        # Validate compose file syntax using docker compose (built-in to Docker)
        if docker compose config > /dev/null 2>&1; then
          echo "âœ… docker-compose.yml syntax is valid!"
        else
          echo "âŒ docker-compose.yml has syntax errors:"
          docker compose config
          exit 1
        fi

    - name: Validate composer.json
      run: |
        echo "ğŸ” Validating composer.json..."
        
        # Check if composer.json is valid JSON
        if jq empty composer.json 2>/dev/null; then
          echo "âœ… composer.json is valid JSON"
        else
          echo "âŒ composer.json has invalid JSON syntax"
          exit 1
        fi
        
        # Check for required PHP version
        if jq -e '.require.php' composer.json > /dev/null 2>&1; then
          php_version=$(jq -r '.require.php' composer.json)
          echo "âœ… PHP version requirement found: $php_version"
        else
          echo "âš ï¸  No PHP version requirement found in composer.json"
        fi
        
        # Check for project name and description
        if jq -e '.name' composer.json > /dev/null 2>&1; then
          project_name=$(jq -r '.name' composer.json)
          echo "âœ… Project name: $project_name"
        fi
        
        # Check for autoload configuration
        if jq -e '.autoload' composer.json > /dev/null 2>&1; then
          echo "âœ… Autoload configuration found"
        else
          echo "âš ï¸  No autoload configuration found in composer.json"
        fi
        
        # List dependencies
        if jq -e '.require' composer.json > /dev/null 2>&1; then
          echo "ğŸ“‹ Main dependencies:"
          jq -r '.require | to_entries[] | "  - \(.key): \(.value)"' composer.json | head -10
        fi

    - name: Validate index.php
      run: |
        echo "ğŸ” Validating index.php..."
        
        # Check if index.php has PHP opening tag
        if ! grep -q "<?php" index.php; then
          echo "âŒ index.php missing PHP opening tag"
          exit 1
        fi
        
        # Check file size (should not be empty)
        file_size=$(stat -c%s index.php)
        if [ $file_size -eq 0 ]; then
          echo "âŒ index.php is empty"
          exit 1
        else
          echo "âœ… index.php exists and has content ($file_size bytes)"
        fi
        
        # Basic PHP syntax check
        if php -l index.php > /dev/null 2>&1; then
          echo "âœ… index.php has valid PHP syntax"
        else
          echo "âŒ index.php has PHP syntax errors:"
          php -l index.php
          exit 1
        fi

    - name: Check file permissions and structure
      run: |
        echo "ğŸ” Checking file permissions and structure..."
        
        # Check Docker files
        for file in docker/Dockerfile docker/docker-compose.yml docker/.dockerignore; do
          if [[ -e "$file" ]]; then
            perms=$(stat -c "%a" "$file")
            echo "  $file permissions: $perms"
            
            if [[ -r "$file" ]]; then
              echo "  âœ“ $file is readable"
            else
              echo "  âŒ $file is not readable"
              exit 1
            fi
          fi
        done
        
        # Check root files
        for file in composer.json index.php; do
          if [[ -e "$file" ]]; then
            perms=$(stat -c "%a" "$file")
            echo "  $file permissions: $perms"
            
            if [[ -r "$file" ]]; then
              echo "  âœ“ $file is readable"
            else
              echo "  âŒ $file is not readable"
              exit 1
            fi
          fi
        done
        
        echo "âœ… File permissions check completed!"

    - name: Validate directory structure
      run: |
        echo "ğŸ” Validating directory structure..."
        
        required_dirs=("docker" "docs" "src" "templates" ".github")
        
        for dir in "${required_dirs[@]}"; do
          if [[ -d "$dir" ]]; then
            echo "  âœ“ /$dir directory exists"
            # Count files in directory
            file_count=$(find "$dir" -type f 2>/dev/null | wc -l)
            echo "    â†’ Contains $file_count file(s)"
          else
            echo "  âŒ /$dir directory is missing"
            exit 1
          fi
        done
        
        echo "âœ… Directory structure validation passed!"

    - name: Generate validation report
      run: |
        echo ""
        echo "ğŸ“Š Docker Configuration Validation Report"
        echo "========================================"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo ""
        echo "ğŸ“ Project Structure:"
        tree -L 2 -a --dirsfirst || ls -la
        echo ""
        echo "ğŸ³ Docker files:"
        ls -lh docker/
        echo ""
        echo "âœ… All configuration files are valid and ready for use!"

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: validate-docker-files
    if: success()
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Verify composer.json exists
      run: |
        if [[ -f "composer.json" ]]; then
          echo "âœ… composer.json exists"
          echo "ğŸ“‹ Project info:"
          jq -r '"\(.name) - \(.description // "No description")"' composer.json
        else
          echo "âŒ composer.json not found!"
          exit 1
        fi
      
    - name: Test Docker build
      run: |
        echo "ğŸ”¨ Testing Docker build process..."
        
        # Show current directory structure for debugging
        echo "ğŸ“‹ Root directory contents:"
        ls -la
        echo ""
        echo "ğŸ“‹ Docker directory contents:"
        ls -la docker/
        
        # Build the Docker image
        echo "ğŸ”¨ Building Docker image..."
        docker build -f docker/Dockerfile -t uchudocs-test:latest .
        
        if [ $? -eq 0 ]; then
          echo "âœ… Docker build successful!"
          
          # Get image information
          echo "ğŸ“‹ Docker image information:"
          docker images uchudocs-test:latest
          docker inspect uchudocs-test:latest --format='Size: {{.Size}} bytes'
          
        else
          echo "âŒ Docker build failed!"
          exit 1
        fi

    - name: Test container startup
      run: |
        echo "ğŸ§ª Testing container startup..."
        
        # Start container
        container_id=$(docker run -d -p 8080:80 uchudocs-test:latest)
        echo "Container ID: $container_id"
        
        # Wait for container to initialize
        echo "â³ Waiting for container to start..."
        sleep 10
        
        # Check if container is still running
        if docker ps | grep -q $container_id; then
          echo "âœ… Container is running"
          
          # Show container logs
          echo "ğŸ“‹ Container logs (last 30 lines):"
          docker logs $container_id | tail -30
          
          # Check container health
          echo ""
          echo "ğŸ” Container inspection:"
          docker inspect $container_id --format='Status: {{.State.Status}}'
          docker inspect $container_id --format='Running: {{.State.Running}}'
          
          # Test if web server responds
          echo ""
          echo "ğŸŒ Testing HTTP response..."
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ | grep -q "200\|403\|404"; then
              response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
              echo "âœ… HTTP server responding with status code: $response_code"
              
              # Show response headers
              echo "ğŸ“‹ Response headers:"
              curl -I http://localhost:8080/ 2>/dev/null | head -10
              break
            else
              echo "â³ Attempt $attempt/$max_attempts: Waiting for HTTP server..."
              if [ $attempt -eq $max_attempts ]; then
                echo "âš ï¸  HTTP server not responding after $max_attempts attempts"
                echo "This may be expected if the application requires additional setup"
              fi
              sleep 3
            fi
          done
          
          # Check if Apache/web server is running
          echo ""
          echo "ğŸ”§ Checking web server process..."
          if docker exec $container_id ps aux | grep -E "apache2|httpd|php-fpm" | grep -v grep; then
            echo "âœ… Web server process found"
          else
            echo "âš ï¸  Web server process not found"
            echo "ğŸ“‹ Running processes:"
            docker exec $container_id ps aux
          fi
          
          # Cleanup
          echo ""
          echo "ğŸ§¹ Cleaning up..."
          docker stop $container_id > /dev/null 2>&1
          docker rm $container_id > /dev/null 2>&1
          echo "âœ… Container stopped and removed"
          
        else
          echo "âŒ Container failed to start or exited immediately"
          echo "ğŸ“‹ Container logs:"
          docker logs $container_id
          docker rm $container_id > /dev/null 2>&1
          exit 1
        fi

    - name: Test Docker Compose
      run: |
        echo "ğŸ”¨ Testing Docker Compose configuration..."
        
        # Change to docker directory
        cd docker
        
        # Validate configuration
        echo "ğŸ” Validating docker-compose.yml..."
        docker compose config --quiet
        
        if [ $? -eq 0 ]; then
          echo "âœ… Docker Compose configuration is valid!"
          
          # Show parsed configuration
          echo ""
          echo "ğŸ“‹ Parsed Docker Compose configuration:"
          docker compose config | head -30
          
          # Show services defined
          echo ""
          echo "ğŸ“‹ Services defined:"
          docker compose config --services
          
        else
          echo "âŒ Docker Compose configuration has issues!"
          docker compose config
          exit 1
        fi
        
        echo ""
        echo "âœ… Docker Compose validation completed successfully!"
